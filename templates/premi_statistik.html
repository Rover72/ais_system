<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIS Dashboard - Premi Statistik</title>
    {% include 'session_guard.html' %}
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <style>
        /* --- RESET & LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100%; }
        .sidebar { width: 260px; background-color: #1e293b; color: #ecf0f1; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .brand { font-size: 24px; font-weight: bold; color: #ffffff; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .brand span { color: #3b82f6; } 
        .menu-label { font-size: 12px; text-transform: uppercase; color: #94a3b8; margin-bottom: 10px; letter-spacing: 1px; font-weight: 600; }
        .menu-nav { list-style: none; margin-bottom: 30px; }
        .menu-nav li { margin-bottom: 5px; }
        .menu-nav a { text-decoration: none; color: #cbd5e1; display: block; padding: 12px 15px; border-radius: 6px; font-size: 14px; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-nav a:hover { background-color: #334155; color: white; }
        .menu-nav a.active { background-color: #2563eb; color: white; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 20px 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-logout { background-color: #ef4444; color: white; padding: 8px 15px; font-size: 12px; text-decoration: none; border-radius: 4px; }
        .filter-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .filter-form { display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; } 
        .form-group { display: flex; flex-direction: column; min-width: 150px; }
        .form-group label { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
        .form-group input, .form-group select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; height: 38px; background-color: white; }
        .btn { padding: 9px 20px; text-decoration: none; border-radius: 4px; font-weight: 500; font-size: 14px; cursor: pointer; border: none; height: 38px; margin-top: 23px; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-download { background-color: #10b981; color: white; display: inline-flex; align-items: center; justify-content: center;}
        .table-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-height: 2000px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 14px; }
        tr:hover { background-color: #f8fafc; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-yellow { background: #fef9c3; color: #854d0e; }
        .bg-gray { background: #f1f5f9; color: #475569; }
        .ts-control { border-radius: 4px; border: 1px solid #ccc; padding: 8px 12px; }
        .ts-wrapper.multi .ts-control > div { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="app-container">
        <nav class="sidebar">
            <div class="brand"><span>AIS</span> System</div>
            <div class="menu-label">Menu Utama</div>
            <ul class="menu-nav">
                <li><a href="/main_menu">Home / Statistik</a></li>
            </ul>
            <div class="menu-label">Laporan Utama</div>
            <ul class="menu-nav">
                <li><a href="/premi_statistik" class="active">Premi Statistik</a></li>
                <li><a href="/klaim_statistik">Klaim Statistik</a></li>
                <li><a href="#">Risk Profile</a></li>
                <li><a href="#">Risk Profile Masa</a></li>
            </ul>
            <div class="menu-label">Pengaturan</div>
            <ul class="menu-nav">
                {% if role == 'admin' %}
                    <li><a href="/manajemen_user">üë§ Manajemen User</a></li>
                    <li><a href="#">‚öôÔ∏è Konfigurasi</a></li>
                {% endif %}
            </ul>
            <div style="margin-top: auto;">
                <p style="font-size: 12px; color: #64748b;">Logged in as:</p>
                <p style="color: white; font-weight: bold;">{{ username }}</p>
            </div>
        </nav>

        <main class="main-content">
            <div class="top-header">
                <h2 style="color: #1e293b; font-size: 20px;">Premi Statistik</h2>
                <a href="/logout" class="btn btn-logout">Logout</a>
            </div>

            <div class="filter-card">
                <form action="/premi_statistik" method="get" class="filter-form">
                    <input type="hidden" name="username" value="{{ username }}">

                    <div class="form-group">
                        <label>Business Type</label>
                        <select name="business_type" id="business_type">
                            <option value="">-- Semua --</option>
                            <option value="Unit AKS" {% if business_type == "Unit AKS" %}selected{% endif %}>Unit AKS</option>
                            <option value="Unit NON AKS" {% if business_type == "Unit NON AKS" %}selected{% endif %}>Unit NON AKS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Policy Group</label>
                        <select name="policy_group" id="policy_group">
                            <option value="">-- Semua --</option>
                            <option value="NON AKS" {% if policy_group == "NON AKS" %}selected{% endif %}>NON AKS</option>
                            <option value="AKS" {% if policy_group == "AKS" %}selected{% endif %}>AKS</option>
                            <option value="AKS Non Konsumtif" {% if policy_group == "AKS Non Konsumtif" %}selected{% endif %}>AKS Non Konsumtif</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Branch / Cabang</label>
                        <select name="branch" id="branch">
                            <option value="">-- Semua --</option>
                            {% for b in branch_list %}
                                <option value="{{ b.cc_code }}" {% if branch == b.cc_code %}selected{% endif %}>
                                    {{ b.description }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group" style="min-width: 250px;">
                        <label>COB</label>
                        <select name="cob" id="cob" multiple placeholder="Pilih COB...">
                            {% for c in cob_list %}
                                <option value="{{ c.pol_type_id }}" 
                                    {% if c.pol_type_id in selected_cob %}selected{% endif %}>
                                    {{ c.description }} {{ c.pol_type_id }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group" style="min-width: 250px;">
                        <label>Company Group Customer</label>
                        <select name="company_group" id="company_group" multiple placeholder="Pilih Group...">
                            {% for g in company_group_list %}
                                <option value="{{ g.grups }}" 
                                    {% if g.grups in selected_company_group %}selected{% endif %}>
                                    {{ g.grupsumbis }} ({{ g.grups }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group" style="min-width: 300px;">
                        <label>Customer</label>
                        <select name="customer" id="customer" multiple placeholder="Ketik nama customer...">
                            {% for c in preloaded_customers %}
                                <option value="{{ c.ent_id }}" selected>
                                    {{ c.ent_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>No. Polis</label>
                        <input type="text" name="pol_no" id="pol_no" placeholder="Cari data..." value="{{ pol_no }}">
                    </div>

                    <div class="form-group">
                        <label>Policy Date Awal</label>
                        <input type="date" name="start_date" id="start_date" value="{{ start_date }}">
                    </div>

                    <div class="form-group">
                        <label>Policy Date Akhir</label>
                        <input type="date" name="end_date" id="end_date" value="{{ end_date }}">
                    </div>

                    <div class="form-group">
                        <label>Rows</label>
                        <select name="limit">
                            <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Filter Data</button>
                    <a href="#" onclick="downloadWithFilter(event)" class="btn btn-download">üì• Excel</a>
                </form>
            </div>

            <div class="table-card">
                <table>
                    <thead>
                        <tr>
                            <th>Pol No</th>
                            <th>Order No</th>
                            <th>Nama</th>
                            <th>Tgl Lahir</th>
                            <th>Periode Awal</th>
                            <th>Periode Akhir</th>
                            <th style="text-align: right;">Sum Insured</th>
                            <th style="text-align: right;">Premi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in report_data %}
                        <tr>
                            <td>{{ row['pol_no'] }}</td>
                            
                            <td>{{ row['order_no'] }}</td>
                            
                            <td>{{ row['nama'] }}</td>
                            
                            <td>{{ row['tgl_lahir'] }}</td>
                            
                            <td>{{ row['periode_awal'] }}</td>
                            
                            <td>{{ row['periode_akhir'] }}</td>
                            
                            <td style="text-align: right;">
                                {{ "{:,.2f}".format(row['tsi_obj_rev'] if row['tsi_obj_rev'] else 0) }}
                            </td>
                            
                            <td style="text-align: right;">
                                {{ "{:,.2f}".format(row['premi_obj_rev'] if row['premi_obj_rev'] else 0) }}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px; color: #94a3b8;">
                                Tidak ada data ditemukan.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <script>
        new TomSelect("#cob", {
            plugins: ['remove_button'],
            create: false,
            maxItems: null,
            placeholder: "Pilih COB..."
        });

        // Tom Select untuk Company Group (Local Data)
        new TomSelect("#company_group", {
            plugins: ['remove_button'],
            create: false,
            maxItems: null,
            placeholder: "Pilih Group..."
        });

        new TomSelect("#customer", {
            plugins: ['remove_button'],
            valueField: 'value', 
            labelField: 'text',  
            searchField: 'text',
            create: false,
            placeholder: "Ketik nama...",
            load: function(query, callback) {
                if (!query.length || query.length < 2) return callback();
                fetch('/api/customers?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(json => {
                        callback(json);
                    }).catch(() => {
                        callback();
                    });
            }
        });

        function downloadWithFilter(event) {
            event.preventDefault(); 
            
            const polNo = document.getElementById('pol_no').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const policyGroup = document.getElementById('policy_group').value;
            const businessType = document.getElementById('business_type').value;
            const branch = document.getElementById('branch').value;
            
            // Multi Selects
            const cobSelect = document.getElementById('cob');
            const selectedCobs = Array.from(cobSelect.selectedOptions).map(option => option.value);

            const groupSelect = document.getElementById('company_group');
            const selectedGroups = Array.from(groupSelect.selectedOptions).map(option => option.value);

            const customerSelect = document.getElementById('customer');
            const selectedCustomers = Array.from(customerSelect.selectedOptions).map(option => option.value);

            let url = `/download_report?dummy=1`;
            
            if (polNo) url += `&pol_no=${encodeURIComponent(polNo)}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (policyGroup) url += `&policy_group=${encodeURIComponent(policyGroup)}`;
            if (businessType) url += `&business_type=${encodeURIComponent(businessType)}`;
            if (branch) url += `&branch=${encodeURIComponent(branch)}`;
            
            selectedCobs.forEach(val => { url += `&cob=${val}`; });
            selectedGroups.forEach(val => { url += `&company_group=${encodeURIComponent(val)}`; }); // Encode karena group mungkin ada spasi
            selectedCustomers.forEach(val => { url += `&customer=${val}`; });
            
            window.location.href = url;
        }
    </script>

    {% include 'chat_widget.html' %}

</body>
</html>